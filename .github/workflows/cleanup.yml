name: System Cleanup

on:
  # Bisa dijalankan manual
  workflow_dispatch:
  # Atau dijadwalkan otomatis (contoh: setiap hari Minggu jam 00:00 UTC)
  schedule:
    - cron: '0 0 * * 0'

permissions:
  actions: write
  contents: read

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # BAGIAN 1: Menghapus Workflow yang Gagal
      - name: Delete Failed Workflow Runs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          echo "Mencari workflow yang gagal..."
          # Mengambil list ID workflow yang gagal (limit 100 terakhir agar tidak timeout)
          runs=$(gh run list --repo $REPO --status failure --limit 100 --json databaseId -q '.[].databaseId')
          
          if [ -z "$runs" ]; then
            echo "Tidak ada workflow gagal yang ditemukan."
          else
            for run_id in $runs; do
              echo "Menghapus Run ID: $run_id"
              gh run delete $run_id --repo $REPO
            done
          fi

      # BAGIAN 2: Menghapus Cache
      - name: clear-cache
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          echo "Mengambil daftar cache..."
          # Mengambil list cache key
          cacheKeys=$(gh cache list --repo $REPO --limit 100 --json key -q '.[].key')

          if [ -z "$cacheKeys" ]; then
            echo "Tidak ada cache yang ditemukan."
          else
            # Jika ingin menghapus SEMUA cache tanpa pandang bulu:
            # gh cache delete --all --repo $REPO --confirm
            
            # Jika ingin menghapus satu per satu (lebih aman untuk debugging log):
            for key in $cacheKeys; do
              echo "Menghapus Cache Key: $key"
              gh cache delete "$key" --repo $REPO
            done
          fi
