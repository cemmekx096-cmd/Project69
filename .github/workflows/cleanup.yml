name: System Cleanup

on:
  # Memungkinkan kamu menjalankan manual dari tab "Actions"
  workflow_dispatch:
  # Berjalan otomatis setiap hari Minggu jam 00:00 UTC
  schedule:
    - cron: '0 0 * * 0'

# Izin yang diperlukan untuk menghapus log dan cache
permissions:
  actions: write
  contents: read

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # BAGIAN 1: Menghapus Workflow yang Gagal (Failure)
      - name: Delete Failed Workflow Runs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          echo "Mencari riwayat workflow yang gagal..."
          # Mengambil daftar ID workflow yang statusnya 'failure'
          runs=$(gh run list --repo $REPO --status failure --limit 100 --json databaseId -q '.[].databaseId')
          
          if [ -z "$runs" ]; then
            echo "Tidak ada riwayat workflow gagal yang ditemukan."
          else
            for run_id in $runs; do
              echo "Menghapus Run ID: $run_id"
              gh run delete $run_id --repo $REPO
            done
            echo "Semua riwayat gagal telah dibersihkan."
          fi

      ---

      # BAGIAN 2: Menghapus Semua Cache
      - name: Clear All Cache
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          echo "Memulai proses pembersihan cache..."
          # --all: Hapus semua cache
          # --succeed-on-no-caches: Jangan anggap error jika cache memang sudah kosong
          gh cache delete --all --repo $REPO --succeed-on-no-caches
          echo "Proses pembersihan cache selesai."
